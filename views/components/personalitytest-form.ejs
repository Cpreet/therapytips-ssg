<form id="personality-test-form" class="flex flex-col gap-6">
    <div class="rounded-lg p-6 shadow-md">
        <input type="hidden" name="testId" value="<%= testId %>">
        <p class="text-lg text-(--therapy-tips-text) font-medium">
            <strong>Step 1:</strong> Rate the following statements based on how much you agree with them on a scale of strongly disagree to strongly agree.
        </p>
        <% questions.forEach((question, index) => { %>
            <%- include('personalitytest-question', { 
                question: question, 
                questionIndex: index 
            }) %>
        <% }); %>
        <%- include('personalitytest-submit') %>
    </div>

    <div class="rounded-lg p-6 shadow-md">
        <%- include('personalitytest-userdetails') %>
    </div>

    <div class="rounded-lg p-6 shadow-md flex flex-col gap-4">
        <p class="text-lg text-(--therapy-tips-text) font-medium">
            <strong>Step 3:</strong>Â Check to make sure you've provided answers to all of the statements/questions above. Once you've done that, click the button below to send your responses to Awake Therapy's Lead Psychologist, Mark Travers, Ph.D. He will provide you with an overview of how you scored relative to others (all answers are anonymized and confidential to protect users' privacy). He can also answer any follow-up questions you may have.
        </p>
        <button type="submit" id="submit-button" class="bg-white text-(--therapy-tips) px-4 py-2 border-2 border-(--therapy-tips) rounded-md
            hover:cursor-pointer hover:bg-(--therapy-tips) hover:text-white opacity-50 cursor-not-allowed
        " disabled>
            Submit Your Answers
        </button>
    </div>
</form>

<script>
document.getElementById('personality-test-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    // Get total questions by counting question elements in the DOM
    const totalQuestions = document.querySelectorAll('[data-question-index]').length;

    // Collect per-question answers from either mobile hidden inputs or desktop radios
    const questionAnswers = [];
    const missingIndexes = [];
    let totalScore = 0;

    for (let i = 0; i < totalQuestions; i++) {
        let value = '';
        const hidden = document.getElementById(`question_${i}_input`);
        if (hidden && hidden.value) {
            value = hidden.value;
        } else {
            const checked = form.querySelector(`input[name="question_${i}"]:checked`);
            if (checked) value = checked.value;
        }

        if (!value) {
            missingIndexes.push(i);
            // highlight missing question block
            const block = document.querySelector(`[data-question-index="${i}"]`);
            if (block) {
                block.style.outline = '2px solid #dc2626';
                block.style.outlineOffset = '2px';
            }
            questionAnswers.push(null);
        } else {
            const numeric = parseInt(value, 10);
            questionAnswers.push(numeric);
            totalScore += isNaN(numeric) ? 0 : numeric;
        }
    }

    if (missingIndexes.length > 0) {
        const firstMissing = missingIndexes[0];
        const firstBlock = document.querySelector(`[data-question-index="${firstMissing}"]`);
        if (firstBlock) firstBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
        alert(`Please answer all questions before submitting. Missing: ${missingIndexes.map(i => i + 1).join(', ')}`);
        return;
    }

    // Prepare mailto content
    function normalizeAge(value) {
        switch (value) {
            case 'under_18': return 'under18';
            case '18_24': return '18to24';
            case '25_34': return '25to34';
            case '35_44': return '35to44';
            case '45_plus': return '45andover';
            default: return value || '';
        }
    }

    function normalizeSimple(value) {
        return (value || '').replace(/_/g, '');
    }

    const ageRaw = formData.get('age') || '';
    const genderRaw = formData.get('gender') || '';
    const regionRaw = formData.get('region') || '';
    const firstName = formData.get('firstName') || '';

    const age = normalizeAge(ageRaw);
    const gender = normalizeSimple(genderRaw);
    const region = normalizeSimple(regionRaw);

    const lines = [];
    questionAnswers.forEach((val, idx) => {
        lines.push(`Question ${idx + 1}: ${val}`);
    });
    lines.push(`Age: ${age}`);
    lines.push(`Gender: ${gender}`);
    lines.push(`Region: ${region}`);
    lines.push(`Name: ${firstName}`);
    lines.push('');
    lines.push("Click send and I'll take care of the rest :)");
    lines.push('- Mark Travers, Ph.D.');

    const subject = '<%= testName %> - Survey Responses';
    const body = lines.join('\n');
    const mailto = `mailto:mark.therapytips@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

    window.location.href = mailto;
});
</script> 